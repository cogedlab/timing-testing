<!doctype html>
<html>
	<head>
  		<title>My experiment</title>
  		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  		<script src="jspsych.js"></script>
 		<script src="plugins/jspsych-text.js"></script>
 		<script src="plugins/jspsych-single-stim.js"></script>
 		<script src="plugins/jspsych-survey-text-table.js"></script>
 		<script src="plugins/jspsych-survey-text.js"></script>
 		<script src="plugins/jspsych-call-function.js"></script>
		<link href="css/jspsych.css" rel="stylesheet" type="text/css"/>
	</head>
	<body>
	</body>
	<script>
		/*image preloading*/
		var preimages = ['img/arugula.jpg', 'img/broccoli.jpg', 'img/brusselsprouts.jpg', 'img/lettuce.jpg', 'img/cabbage.jpg', 'img/celery.jpg', 'img/kale.jpg', 'img/cucumber.jpg', 'img/eggplant.jpg', 'img/avocado.jpg', 'img/bellpepper.jpg', 'img/pumpkin.jpg', 'img/asparagus.jpg', 'img/cauliflower.jpg', 'img/garlic.jpg', 'img/onion.jpg', 'img/carrot.jpg', 'img/potato.jpg', 'img/peas.jpg', 'img/bokchoy.jpg', 'img/squash.jpg', 'img/chard.jpg', 'img/caper.jpg', 'img/okra.jpg', 'img/radish.jpg'];
		jsPsych.preloadImages(preimages, function(){ startExperiment(); });

		/*Random number id creation and condition assignment*/
		var id_num = Math.floor(Math.random()*100000);
		var cond_num = Math.round(Math.random());
		if (cond_num == 1){
			cond = "rstd";
		} else {
			cond = "retv";
		};
		
		id = id_num + "_" + cond;
		
		/*Get Amazon ID*/
		var mTurk_ID_block = {
			type: 'survey-text',
			questions: [["What is your Amazon mTurk user ID? "]]
		};
		
		/*Instructions block*/
		var instructions = {
			type: "text",
			text: "<b>Welcome to our study.</b>" + 
			"<p>In this study, you will be shown some sentences. Please try and remember them and how they relate to one another.</p>" + 
          "<br><p>Please do <b>NOT</b> <u>refresh the page</u> or <u>tab away</u> during the study or you <u>will not</u> be compensated.</p><br>" +
          "<p>Press any key to begin. This study should take you approximately 15 minutes. You will receive a numerial code at the conclusion of the study to input into mTurk.</p>"
        };

		/*
		 * The first presentation of the scenarios
		 */
		
		/*Scenarios Stimuli*/
		var s1_stim = ['Students commute from off-campus housing to campus by 3 routes.<br><br>',
		'On Ash, students may walk, bike, or drive.<br><br>',
		'On Birch, only walking is allowed.<br><br>',
		'On Canyon, only biking or walking is allowed.<br><br>',
		'If it is raining, students do not bike.<br><br>',
		'If it is hot, students drive to campus or take Birch.<br><br>',
		'Freshmen are not allowed to have cars.<br><br>'];
		
		/*Randomize the premises*/
		function randPremises(stimuli){
			//Randomize
			var stim_proc = jsPsych.randomization.repeat(stimuli,1);
			var stim_out = [];
			//Concatenate
			for (i=0; i<stim_proc.length; i++) {
				stim_out += stim_proc[i];
			}
			return stim_out;
		};
		
		/*Make a scenario block*/
		function makeScen(premises) {
			var premises_block = {
				type: "single-stim",
				stimuli: function(){return randPremises(premises);},
				is_html: true,
			};
			return premises_block;
		}
		
		
		/*
		 * Restudy/Retrieval Portion
		 */
		
		/*Scenario 1 Retv*/
		var s1_retv_stim = ['Students commute from off-campus housing to campus by any of _____ routes.',
		'On Ash, students may _____, _____, or _____.',
		'On Birch, only _____ is allowed.',
		'On Canyon, only _____ or _____ is allowed',
		'If it is raining, students do not _____.',
		'If it is hot, students _____ to campus or take _____.',
		'Freshmen are not allowed to have _____.'];
		
		var s1_retv_back = ['Students commute from off-campus housing to campus by any of <u>_3_</u> routes.',
		'On Ash, students may <u>walk</u>, <u>bike</u>, or <u>drive</u>.',
		'On Birch, only <u>walking</u> is allowed.',
		'On Canyon, only <u>biking</u> or <u>walking</u> is allowed.',
		'If it is raining, students do not <u>bike</u>.',
		'If it is hot, students <u>drive</u> to campus or take <u>Birch</u>.',
		'Freshmen are not allowed to have <u>cars</u>.',];
		
		/*Scenario 1 Question Randomization*/
		
		function randRetvIndex(retv_stim) {
			var nums = [];
			for (i=0;i<retv_stim.length;i++) {
				nums[i] = i;
			}
			nums = jsPsych.randomization.repeat(nums,1);
			return nums;
		}
		
		function randRetv(nums, retv_stim){
			var stim = [];
			for (i=0;i<nums.length;i++){
				stim[i]=retv_stim[nums[i]];
			}
			return stim;
		}
		
		var nums_real;
		
		function makeRetv(retv, back) {
			/*Make Retrival Block*/
			var retv_block = {
				type: 'survey-text-table',
				questions: [function() {
					nums_real = randRetvIndex(retv);
					return randRetv(nums_real, retv);}]
			};
			var back_block = {
				type: 'survey-text-table',
				questions: [function() {
					return randRetv(nums_real, back);}]
			};
			out = [retv_block, back_block];
			return out;
		}
		
		/*
		 * Final Test Portion
		 */
		
		/*Scenario 1 Questions*/
		var scenario1_qs = [['On which route(s) can students BIKE to campus?<hr><br>a. Ash only<br>b. Ash or Birch<br>c. Birch or Canyon<br>d. Ash or Canyon<br>e. Ash or Birch or Canyon'],
			['On which route(s) can students DRIVE to campus?<hr><br>a. Ash only<br>b. Ash or Birch<br>c. Birch or Canyon<br>d. Ash or Canyon<br>e. Ash or Birch or Canyon'],
			['Which route(s) do students use when it is HOT?<hr><br>a. Ash only<br>b. Ash or Birch<br>c. Birch or Canyon<br>d. Ash or Canyon<br>e. Ash or Birch or Canyon'],
			["How might students commute to campus via BIRCH on a RAINY day? (Correct answer should include all possibilites.)<hr><br>a. walk <br>b. bike<br>c. drive<br>d. walk or drive<br>e. none-student don't use Birch on RAINY day"],
			['Which form(s) of transportation are allowed on all 3 routes?<hr><br>a. walking<br>b. biking<br>c. driving<br>d. walking or driving<br>e. walking and biking'],
			['How might students commute to campus on a HOT day? (Correct answer should include all possibilites.)<hr><br>a. walk <br>b. bike<br>c. drive<br>d. walk or drive<br>e. bike or drive'],
			['How might FRESHMEN students commute to campus on a HOT day? (Correct answer should include all possibilites.)<hr><br>a. walk <br>b. bike<br>c. drive<br>d. walk or drive<br>e. bike or drive'],
			["How might students commute to campus via CANYON on a HOT day? (Correct answer should include all possibilites.)<hr><br>a. bike<br>b. drive<br>c. bike or drive<br>d. walk or drive<br>e. none: students don't use Canyon on hot days"]];
		
		var scenario1_questions = {
			type: 'single-stim',
			stimuli: scenario1_qs,
			is_html: true,
			choices: ['a','b','c','d','e'],
			prompt: "<br><hr>Please key in your response (<b>a, b, c, d, e</b>)."
		};
		
		
		/*Last Page*/
		var last_page = {
			type: 'text',
			text: "<b>Thank you for your participation!</b><br><p>If you have any questions or concerns, email admin@cognition-learning.org."+
			"<br><p>Your mTurk confirmation code is on the following page. Press any key to continue.</p>"
		};
		
		var startTime;
		var start_review_time = {
			type: 'call-function',
			func: function(){
				startTime = (new Date()).getTime();
			}
		};
		
		if (cond_num == 1){
			loopTimeline = [makeScen(s1_stim)];
		} else {
			loopTimeline = makeRetv(s1_retv_stim, s1_retv_back);
		}
		
		var review_loop = {
			chunk_type: 'while',
			timeline: loopTimeline,
			continue_function: function(){
				var currentTime = (new Date()).getTime();
				if(currentTime-startTime > 30 * 1000){ //30s * 1000ms
					return false;
				} else {
					return true;
				}
			}
		};
		
		
		var trial = jsPsych.currentTrial();
		console.log(trial.type);
		
		/*Create experiment array*/
		var experiment = [];
		experiment.push(mTurk_ID_block);
		experiment.push(instructions);
		experiment.push(makeScen(s1_stim));
		experiment.push(start_review_time);
		experiment.push(review_loop);
		experiment.push(scenario1_questions);
		experiment.push(last_page);
		
		/*Save data function*/
		function saveData(filename, filedata){
			$.ajax({
				type:'post',
				cache: false,
				url: 'save_data.php',
				data: {filename: filename, filedata: filedata}
			});
		}
		
		/*Start the experiment*/
		function startExperiment() {
			jsPsych.init({
				experiment_structure: experiment,
				on_finish: function(data) {
					saveData(id + ".csv", jsPsych.data.dataAsCSV());
					jsPsych.data.displayData('csv');
					//document.write("<center><h1>Your mTurk Code is <u>"+id+"</u></h1></center>");
				}
			});
		}
		
	</script>
</html>